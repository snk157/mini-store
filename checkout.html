<!DOCTYPE html>
<html>
  <head>
    <title>Ministore</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/refs/heads/master/json/countries%2Bstates%2Bcities.json"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- script ================================================== -->
    <script>
      const token = localStorage.getItem("token");
      if(!token)
      {
        window.location.href = `${window.location.origin}/login.html`;
      }

      function loadHeaderFooter() {
        // Fetch and insert header content
        fetch('header.html')
          .then(response => response.text())
          .then(data => {
            document.getElementById('header-container').innerHTML = data;
          });

        // Fetch and insert footer content
        fetch('footer.html')
          .then(response => response.text())
          .then(data => {
            document.getElementById('footer-container').innerHTML = data;
          });
        }

      async function populateCountriesAndStates() {
        const countrySelect = document.getElementById('country-select');
        const stateSelect = document.getElementById('state-select');

        try {
          // Fetch the JSON data from your provided API
          const response = await fetch("https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/json/countries%2Bstates%2Bcities.json");
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const countries = await response.json();

          // Populate the country dropdown
          countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country.id; // Store country ID for fetching states
            option.textContent = country.name;
            countrySelect.appendChild(option);
          });

          // Listen for country selection changes to populate states
          countrySelect.addEventListener('change', function () {
            const selectedCountryId = this.value;
            const selectedCountry = countries.find(country => country.id == selectedCountryId);

            // Clear previous state options
            stateSelect.innerHTML = '<option selected="" hidden="">Select your state</option>';

            if (selectedCountry && selectedCountry.states.length > 0) {
              // Populate the state dropdown with states from the selected country
              selectedCountry.states.forEach(state => {
                const stateOption = document.createElement('option');
                stateOption.value = state.id; // Store state ID
                stateOption.textContent = state.name;
                stateSelect.appendChild(stateOption);
              });
            }
          });
        } catch (error) {
          console.error('Error fetching or populating data:', error);
        }
      }

      async function fetchCart() {
        try {
          const response = await axios.get(`https://mini-store-api-ud3r.onrender.com/carts`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const cartItems = response.data.data;

          // Populate the cart dynamically
          populateOrder(cartItems);
        } catch (error) {
          console.error('Error fetching cart data:', error);
        }
      }
        
      function populateOrder(orderItems) {
        const orderDetails = document.getElementById('order-details');
        const grandTotalElement = document.getElementById('grand-total');
        let grandTotal = 0;

        orderDetails.innerHTML = '';

        orderItems.forEach((item) => {
          const total = item.price * item.qty;
          grandTotal += total;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="text-end">${item.product_name}</td>
            <td class="text-end">${item.qty}</td>
            <td class="text-end">$${total.toFixed(2)}</td>
          `;
          orderDetails.appendChild(row);
        });

        // Update grand total
        grandTotalElement.textContent = `$${grandTotal.toFixed(2)}`;
      }

      async function createOrder() {
        const orderData = {
          firstname: document.getElementById('fname').value.trim(),
          lastname: document.getElementById('lname').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          email: document.getElementById('email').value.trim(),
          address: document.getElementById('adr').value.trim(),
          address2: document.getElementById('adr2').value.trim(),
          country: document.getElementById('country-select').value,
          state: document.getElementById('state-select').value,
          city: document.getElementById('city').value.trim(),
          zip: document.getElementById('zip').value.trim(),
          notes: document.getElementById('order-notes').value.trim(),
          status: 'pending',
        };

        const response = await axios.get(`https://mini-store-api-ud3r.onrender.com/orders`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (response.status === 200)
        {
          const { stripePublicKey, clientSecret } = response.data.data;
          const stripe = Stripe(stripePublicKey);
          const elements = stripe.elements();
          const cardElement = elements.create('card');
          cardElement.mount('#card-element');

          const { error, paymentIntent } = await stripe.confirmPayment({
            clientSecret,
            payment_method: {
              card: cardElement,
              billing_details: {
                name: `${orderData.firstname} ${orderData.lastname}`,
              },
            },
          });

          if (error) {
            console.error('Payment failed:', error.message);
            alert('Payment failed: ' + error.message);
          } else if (paymentIntent && paymentIntent.status === 'succeeded') {
            alert('Payment succeeded! Thank you for your order.');
          }
        } else {
          alert('Something went wrong while creating the order.');
        }
      }

      document.addEventListener('DOMContentLoaded', populateCountriesAndStates);
      // Call function to load header and footer
      window.onload = function () {
        loadHeaderFooter();
        fetchCart();
      };
    </script>
    <!-- script ================================================== -->
    <script src="js/modernizr.js"></script>
  </head>
  <div id="header-container"></div>
    <section class="hero-section position-relative bg-light-blue padding-medium">
      <div class="hero-content">
        <div class="container">
          <div class="row">
            <div class="text-center padding-large no-padding-bottom">
              <h1 class="display-2 text-uppercase text-dark">Checkout</h1>
              <div class="breadcrumbs">
                <span class="item">
                  <a href="index.html">Home ></a>
                </span>
                <span class="item">Checkout</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="shopify-cart checkout-wrap padding-large">
      <div class="container">
        <div class="row d-flex flex-wrap">
          <div class="col-lg-6">
            <h2 class="display-7 text-uppercase text-dark pb-4">Billing Details</h2>
            <div class="billing-details">
              <div class="name-fields d-flex">
                <div class="field-wrapper me-2 flex-grow-1">
                  <label for="fname">First Name*</label>
                  <input type="text" id="fname" name="firstname" class="form-control mt-2 mb-4 ps-3">
                </div>
                <div class="field-wrapper flex-grow-1">
                  <label for="lname">Last Name*</label>
                  <input type="text" id="lname" name="lastname" class="form-control mt-2 mb-4 ps-3">
                </div>
              </div>
              <label for="email">Phone *</label>
              <input type="text" id="phone" name="phone" class="form-control mt-2 mb-4 ps-3">
              <label for="email">Email address *</label>
              <input type="text" id="email" name="email" class="form-control mt-2 mb-4 ps-3">
              <label for="address">Address*</label>
              <input type="text" id="adr" name="address" placeholder="House number and street name" class="form-control mt-3 ps-3 mb-3">
              <input type="text" id="adr2" name="address2" placeholder="Appartments, suite, etc." class="form-control ps-3 mb-4">
              <label for="country-select">Country / Region*</label>
              <select id="country-select" class="form-select form-control mt-2 mb-4">
                <option selected="" hidden="">Select your country</option>
              </select>
              <label for="state-select">State *</label>
              <select id="state-select" class="form-select form-control mt-2 mb-4">
                <option selected="" hidden="">Select your state</option>
              </select>
              <label for="city">Town / City *</label>
              <input type="text" id="city" name="city" class="form-control mt-3 ps-3 mb-4">
              <label for="zip">Zip Code *</label>
              <input type="text" id="zip" name="zip" class="form-control mt-2 mb-4 ps-3">
            </div>
          </div>
          <div class="col-lg-6">
            <h2 class="display-7 text-uppercase text-dark pb-4">Additional Information</h2>
            <div class="billing-details">
              <label for="order-notes">Order notes (optional)</label>
              <textarea id="order-notes" class="form-control pt-3 pb-3 ps-3 mt-2"></textarea>
            </div>
            <div class="your-order mt-5">
              <h2 class="display-7 text-uppercase text-dark pb-4">Cart Totals</h2>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="order-details">
                  <!-- Order details will be populated here -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="2" class="text-end"><strong>Grand Total</strong></td>
                    <td id="grand-total" class="text-end">$0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <button id="create-order-btn" class="btn btn-primary mt-4" onclick="createOrder()">Place Order</button>
          </div>
        </div>
      </div>
    </section>    
    <section id="subscribe" class="container-grid position-relative overflow-hidden">
      <div class="container">
        <div class="row">
          <div class="subscribe-content bg-dark d-flex flex-wrap justify-content-center align-items-center padding-medium">
            <div class="col-md-6 col-sm-12">
              <div class="display-header pe-3">
                <h2 class="display-7 text-uppercase text-light">Subscribe Us Now</h2>
                <p>Get latest news, updates and deals directly mailed to your inbox.</p>
              </div>
            </div>
            <div class="col-md-5 col-sm-12">
              <form class="subscription-form validate">
                <div class="input-group flex-wrap">
                  <input class="form-control btn-rounded-none" type="email" name="EMAIL" placeholder="Your email address here" required="">
                  <button class="btn btn-medium btn-primary text-uppercase btn-rounded-none" type="submit" name="subscribe">Subscribe</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section id="instagram" class="padding-large overflow-hidden">
      <div class="container">
        <div class="row">
          
        </div>
      </div>
    </section>
    <div id="card-element"></div>
  <div id="footer-container"></div>
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="js/plugins.js"></script>
    <script type="text/javascript" src="js/script.js"></script>
  </body>
</html>